<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="libs/md5.js"></script>
  <script src="libs/utils.js"></script>
  <script src="libs/purl.js"></script>
  <script src="js-subsonic/jqsubsonic.js"></script>
  <script src="pitunes.js"></script>
  <script>
  function getUrlVars() {
    var vars = {};
  	var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
  		vars[key] = value;
  	});
  	return vars;
  }
  var settings = {
    server: 'http://192.168.2.203:4040',
    username: 'jukebox',
    password: 'pippo',
    bitrate: 0,
    type: (getUrlVars()["type"]) ? getUrlVars()["type"] : 'random',
    listlen: 10, // step di visualizzazione copertine
    watchInt: 10000 // tempo di aggiornamento del player
    },
    albumList = {},
    offset = 0,
    playingInt = null;
  // mi connetto al server
  JQSubSonic.open(settings.server, settings.username, settings.password, settings.bitrate, function(err, res) {
    if (err) {
      console.warn("err", err, err.error, typeof err.error);
      return;
    } else {
      //console.log(res);
      getAlbumList(settings.listlen, offset);
      offset += settings.listlen;
    }
  });
  function playingWatch() {
    playingInt = setInterval(function() {
      jukeGet();
    }, settings.watchInt);
  }
  $(function() {
    // Each time the user scrolls
    /*var win = $(window);
  	win.scroll(function() {
  		// End of the document reached?
  		if ($(document).height() - win.height() == win.scrollTop()) {
        console.log('end reached');
      }
    });*/
    $('a#more').click(function() {
      getAlbumList(settings.listlen, offset);
      offset += settings.listlen;
    });
    $('div#player a#play').click(jukePlay);
    $('div#player a#stop').click(jukeStop);
    $('div#list').on('click', 'div.album', function() {
      $('div#detail').hide();
      $('div.album').removeClass('flip');
      var id = $(this).attr('ref');
      console.log('hai premuto '+id);
      $('div#detail div.albumDetails').html('loading...');
      $(this).toggleClass('flip');
      getDetails(id);
      $('div#detail').toggle();
    });
    $('div#detail div.close a').click(function(e) {
      $('div#detail').hide();
      $('div.album').removeClass('flip');
    });
    $('div.modal').click(function(e) {
      if($(e.target).attr('id') == 'detail') {
        $('div#detail').hide();
        $('div.album').removeClass('flip');
      }
    });
    $('div#detail').on('click', 'a#playAll, div.track', function() {
      var id = $(this).attr('ref');
      console.log('hai premuto '+id);
      params = {
        id: id
      };
      JQSubSonic.jukeboxControl('set', params, function(err, res) {
        if(err) {
          console.warn("err", err, err.error, typeof err.error);
          return;
        } else {
          console.log(res);
          jukePlay();
        }
      });
    });
    jukeGet();
    playingWatch();
  });
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id='pitunes'>
    <h2>pitunes</h2>
  </div>
  <div id='type'>
    <a href='?type=random' class='button'>random</a>
    <a href='?type=newest' class='button'>newest</a>
    <a href='?type=frequent' class='button'>frequent</a>
    <a href='?type=recent' class='button'>recent</a>
  </div>
  <div id='player'>
    <a href='javascript:void(0)' class='button' id='play'>play</a>
    <a href='javascript:void(0)' class='button' id='stop'>stop</a><br />
    Now Playing: <div id='nowPlaying'></div><br />
  </div>
  <div id='list'></div>
  <div id='detail' class='modal'>
    <div class='modal-content'>
      <div class='close'>
        <a href='javascript:void(0)' class='button'>Ã—</a>
      </div>
      <div class='albumDetails'>loading...</div>
    </div>
  </div>
  <div style='clear: both'></div>
  <a href='javascript:void(0)' id='more' class='button'>more</a>
</body>
</html>
