<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="libs/md5.js"></script>
  <script src="libs/utils.js"></script>
  <script src="libs/purl.js"></script>
  <script src="js-subsonic/jqsubsonic.js"></script>
  <script>
  var subsonic = {
    server: 'http://192.168.2.203:4040',
    username: 'jukebox',
    password: 'pippo',
    bitrate: 0
  };
  // mi connetto al server
  JQSubSonic.open(subsonic.server, subsonic.username, subsonic.password, subsonic.bitrate, function(err, res) {
    if (err) {
      console.warn("err", err, err.error, typeof err.error);
      return;
    } else {
      console.log(res);
      var params = {
        size: 20
      };
      // ottengo la lista degli album
      JQSubSonic.getAlbumList('recent', params, function(err2, res2) {
        if (err2) {
          console.warn("err2", err2, err2.error, typeof err2.error);
          return;
        } else {
          console.log(res2);
          console.log('dischi: '+res2.albumList.album.length);
          for (var i = 0; i < res2.albumList.album.length; i++) {
            console.log(res2.albumList.album[i]);
            var cover = JQSubSonic.getCoverArtURL(res2.albumList.album[i].coverArt, 250);
            $('div#list').append("<div><img class='cover' ref='"+res2.albumList.album[i].id+"' src='"+cover+"' /></div>");
          }
        }
      });
    }
  });
  var playingInt = null;
  function playingWatch() {
    playingInt = setInterval(function() {
      jukeGet();
    }, 10000);
  }
  function jukeGet() {
    JQSubSonic.jukeboxControl('get', null, function(err, res) {
      if(err) {
        console.warn("err", err, err.error, typeof err.error);
        return;
      } else {
        console.log(res);
        if(res.jukeboxPlaylist.playing) {
          var song = res.jukeboxPlaylist.entry[res.jukeboxPlaylist.currentIndex]
          $('div#nowPlaying').text(song.artist+" - "+song.title+" - "+song.album);
        } else {
          console.log('jukebox fermo');
          $('div#nowPlaying').text('');
          clearInterval(playingInt);
        }
      }
    });
  }
  $(function() {
    $('div#player input#play').click(function() {
      JQSubSonic.jukeboxControl('start', null, function(err, res) {
        if(err) {
          console.warn("err", err, err.error, typeof err.error);
          return;
        } else {
          console.log(res);
          jukeGet();
          if(res.jukeboxStatus.playing) playingWatch();
        }
      });
    });
    $('div#player input#stop').click(function() {
      JQSubSonic.jukeboxControl('stop', null, function(err, res) {
        if(err) {
          console.warn("err", err, err.error, typeof err.error);
          return;
        } else {
          console.log(res);
          if(!res.jukeboxStatus.playing) clearInterval(playingInt);
          jukeGet();
        }
      });
    });
    /*$('div#player input#update').click(function() {
      JQSubSonic.jukeboxControl('get', null, function(err, res) {
        if(err) {
          console.warn("err", err, err.error, typeof err.error);
          return;
        } else {
          console.log(res);
          if(res.jukeboxPlaylist.playing) {
            var song = res.jukeboxPlaylist.entry[res.jukeboxPlaylist.currentIndex]
            $('div#nowPlaying').text(song.artist+" - "+song.title+" - "+song.album);
          } else {
            console.log('jukebox fermo');
          }
        }
      });
    });*/
    $('div#list').on('click', 'img.cover', function() {
      var id = $(this).attr('ref');
      console.log('hai cliccato: '+id);
      params = {
        id: id
      };
      JQSubSonic.jukeboxControl('set', params, function(err, res) {
        if(err) {
          console.warn("err", err, err.error, typeof err.error);
          return;
        } else {
          console.log(res);
        }
      });
      /*JQSubSonic.getMusicDirectory(id, function(err, res) {
        if(err) {
          console.warn("err", err, err.error, typeof err.error);
          return;
        } else {
          console.log('canzoni: '+res.album.song.length);
          for (var i = 0; i < res.album.song.length; i++) {
            console.log(res.album.song[i]);
          }
        }
      });*/
    });
    jukeGet();
    playingWatch();
  });
  </script>
  <style>
  div#player {
    border: 1px solid black;
    width: 100%;
  }
  div#list {
    margin: auto;
    width: 100%;
  }
  div#list div {
    text-align: center;
    width: 250px;
    margin: 5px;
    float: left;
  }
  div#list div > img {
    width: 250px;
    height: 250px;
    background-color: #000;
  }
  </style>
</head>
<body>
  <h2>pitunes</h2>
  <div id='player'>
    <input type='button' id='play' value='play' />
    <input type='button' id='stop' value='stop' />
    <input type='button' id='update' value='update' /><br />
    Now Playing: <div id='nowPlaying' /><br />
  </div>
  <div id='list'></div>
</body>
</html>
