<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="libs/md5.js"></script>
  <script src="libs/utils.js"></script>
  <script src="libs/purl.js"></script>
  <script src="js-subsonic/jqsubsonic.js"></script>
  <script src="pitunes.js"></script>
  <script>
  function getUrlVars() {
    var vars = {};
  	var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
  		vars[key] = value;
  	});
  	return vars;
  }
  var settings = {
    server: 'http://192.168.2.203:4040',
    username: 'jukebox',
    password: 'pippo',
    bitrate: 0,
    type: (getUrlVars()["type"]) ? getUrlVars()["type"] : 'random',
    listlen: 10, // step di visualizzazione copertine
    watchInt: 10000 // tempo di aggiornamento del player
    },
    albumList = {},
    offset = 0,
    playingInt = null,
    playlist = [];
  // mi connetto al server
  JQSubSonic.open(settings.server, settings.username, settings.password, settings.bitrate, function(err, res) {
    if (err) {
      console.warn("err", err, err.error, typeof err.error);
      return;
    } else {
      //console.log(res);
      getAlbumList(settings.listlen, offset);
      offset += settings.listlen;
    }
  });
  function playingWatch() {
    playingInt = setInterval(function() {
      jukeGet();
    }, settings.watchInt);
  }
  $(function() {
    // Each time the user scrolls
    /*var win = $(window);
  	win.scroll(function() {
  		// End of the document reached?
  		if ($(document).height() - win.height() == win.scrollTop()) {
        console.log('end reached');
      }
    });*/
    $('a#more').click(function() {
      getAlbumList(settings.listlen, offset);
      offset += settings.listlen;
    });
    $('div#player span#play').click(jukePlay);
    $('div#player span#stop').click(jukeStop);
    $('div#player span#playlist').click(function() {
      $('div#detail').hide();
      $('div#detail div.modal-content').html('');
      $(playlist).each(function(i,song) {
        $('div#detail div.modal-content').append(
          "<div class='track'>\n"+
            song.artist+" - "+song.title+" - "+song.album+"\n"+
          "</div>\n"
        );
      });
      $('div#detail').toggle();
    });
    $('div#list').on('click', 'div.album', function() {
      $('div#detail').hide();
      $('div.album').removeClass('flip');
      var id = $(this).attr('ref');
      console.log('hai premuto '+id);
      $('div#detail div.modal-content').html('loading...');
      $(this).toggleClass('flip');
      getDetails(id);
      $('div#detail').toggle();
    });
    $('a#close').click(function(e) {
      $('div#detail').hide();
      $('div.album').removeClass('flip');
    });
    $('div.modal').click(function(e) {
      if($(e.target).attr('id') == 'detail') {
        $('div#detail').hide();
        $('div.album').removeClass('flip');
      }
    });
    $('div#detail').on('click', 'a#playAll, div.track', function() {
      var id = $(this).attr('ref');
      console.log('hai premuto '+id);
      params = {
        id: id
      };
      JQSubSonic.jukeboxControl('set', params, function(err, res) {
        if(err) {
          console.warn("err", err, err.error, typeof err.error);
          return;
        } else {
          console.log(res);
          jukePlay();
        }
      });
    });
    jukeGet();
    playingWatch();
  });
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id='topbar'>
    <div id='pitunes'>
      <h2 onclick='location.reload()'>pitunes</h2>
    </div>
    <div id='player'>
      <div id='buttons'>
        <span class="icon button" id='play'>play3</span>
        <span class="icon button" id='stop'>stop2</span>
        <span class="icon button" id='playlist'>stack</span>
      </div>
      <div id='nowPlayingDiv'>
        <span class="icon">headphones</span>
        <span id='nowPlaying'>Player paused</span>
      </div>
    </div>
    <div id='type'>
      <a href='?type=random' class='button'><span class='icon'>random</span> random</a>
      <a href='?type=newest' class='button'><span class='icon'>power</span> newest</a>
      <a href='?type=frequent' class='button'><span class='icon'>heart</span> frequent</a>
      <a href='?type=recent' class='button'><span class='icon'>history</span> recent</a>
    </div>
  </div>
  <div id='list'></div>
  <div id='detail' class='modal'>
    <div class='modal-inside'>
      <div class='close'>
        <a href='javascript:void(0)' class='button' id='close'><span class="icon">cross</span>&nbsp;</a>
      </div>
      <div class='modal-content'>loading...</div>
    </div>
  </div>
  <div id="moreButton">
    <a href='javascript:void(0)' class='button' id='more'><span class="icon">plus</span> more</a>
  </div>
  <br /><br />
</body>
</html>
